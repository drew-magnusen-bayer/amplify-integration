const getAppRoleToken = require('./getAppRoleToken');
const vaultFactory = require('node-vault');

let lastClientToken = '';
let cachedVaultUrl = null;
let cachedCredentials = null;
let cachedVault = null;

function getVault(vaultUrl = cachedVaultUrl, credentials = cachedCredentials) {
	return getAppRoleToken(vaultUrl, credentials).then((clientToken) => {
		cachedVaultUrl = vaultUrl;
		cachedCredentials = credentials;
		if(lastClientToken !== clientToken) {
			const options = {
				endpoint: vaultUrl,
				token: clientToken
			};
			cachedVault = vaultFactory(options)
		}
		return cachedVault;
	});
}

module.exports = getVault;