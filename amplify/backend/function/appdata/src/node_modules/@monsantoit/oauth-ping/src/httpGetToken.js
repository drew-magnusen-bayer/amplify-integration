const moment = require('moment')
const objectHash = require('object-hash')
const oauthAPI = require('./oauthAPI')

const dependencies = {
    now: Date.now,
    state: {}
}

const cache = {}

const cacheResult = (key, response) => {
    const {now} = dependencies
    const {access_token, expires_in} = response.body

    cache[key].value = access_token

    // expire 30 seconds early to make sure our token is valid
    cache[key].expiration = moment(now())
        .add(expires_in - 30, 'seconds')
        .valueOf()

    cache[key].expires_in = expires_in

    return cache[key]
}

const httpGetToken = ({
    clientId,
    clientSecret,
    url = 'https://test.amp.monsanto.com/as/token.oauth2',
    autoRefresh = true,
    refreshRate = 1000,
    scope = url.includes('login.microsoftonline.com') ? `${clientId}/.default` : '',
    logger = console
}) => (callback) => {
    const logError = (message, err) => {
        const actualLogger = !logger.error || typeof logger.error !== 'function' ? console : logger
        actualLogger.error(message, err)
    }
    const {now} = dependencies
    const {state} = dependencies

    const cacheKey = objectHash({clientId, clientSecret, url, scope})
    if (!cache[cacheKey]) {
        cache[cacheKey] = {}
    }
    if (!state[cacheKey]) {
        state[cacheKey] = {autoRefresh, refreshRate}
    }
    if (
        autoRefresh !== state[cacheKey].autoRefresh ||
        refreshRate !== state[cacheKey].refreshRate
    ) {
        clearTimeout(state[cacheKey].timeoutId)
        cache[cacheKey] = {}
        state[cacheKey].autoRefresh = autoRefresh
        state[cacheKey].refreshRate = refreshRate
    }

    if (cache[cacheKey].value && cache[cacheKey].expiration > now()) {
        const token = cache[cacheKey].value

        if (callback != null) {
            callback(null, token)
        }

        return Promise.resolve(token)
    } else if (state[cacheKey].promise) {
        return state[cacheKey].promise
    } else {
        const request = () =>
            oauthAPI
                .receiveToken({clientId, clientSecret, url, scope})
                .then((response) => {
                    const {expires_in, value} = cacheResult(cacheKey, response)

                    // autorefresh a little faster than manual refresh.
                    if (state[cacheKey].autoRefresh) {
                        clearTimeout(state[cacheKey].timeoutId)
                        state[cacheKey].timeoutId = setTimeout(
                            () => request(),
                            (expires_in - 90) * state[cacheKey].refreshRate
                        )
                    }
                    return value
                })
                .catch((err) => {
                    // On network/ping server failure, try again in 30 seconds.
                    if (state[cacheKey].autoRefresh && err.statusCode !== 401) {
                        logError(
                            `Error occurred in @monsanto/oauth-ping retrieving oauth token: `,
                            err
                        )
                        clearTimeout(state[cacheKey].timeoutId)
                        state[cacheKey].timeoutId = setTimeout(
                            () => request(),
                            30 * state[cacheKey].refreshRate
                        )
                    } else {
                        throw err
                    }
                })

        const promise = () =>
            request()
                .then((token) => {
                    state[cacheKey].promise = null

                    if (callback != null) {
                        return callback(null, token)
                    } else {
                        return token
                    }
                })
                .catch((err) => {
                    state[cacheKey].promise = null

                    if (callback != null) {
                        return callback(err, null)
                    } else {
                        throw err
                    }
                })

        state[cacheKey].promise = promise()

        return state[cacheKey].promise
    }
}

const refresh = {
    disable() {
        const {state} = dependencies
        Object.keys(state).forEach((key) => {
            state[key].autoRefresh = null
            clearTimeout(state[key].timeoutId)
        })
    }
}

module.exports = refresh

module.exports = Object.assign(httpGetToken, {dependencies, refresh, cache})
