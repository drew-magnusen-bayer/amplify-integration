# superagent-oauth

This library aids developers in making HTTP requests to Bayer OAuth protected endpoints. Under the hood it uses the [superagent](https://visionmedia.github.io/superagent/) library, with additional capabilities to handle Bayer authentication.

# Table of Contents

- [Features](#Features)
- [Install](#Install)
- [Setup](#Setup)
  1. [Ping](#Ping)
  2. [Azure](#Azure)
  3. [Overriding options](#overridingOptions)
- [Usage](#Usage)
  1. [Ping Usage](#PingUsage)
  2. [Ping Overriding Options Usage](#PingWithOverridesUsage)
  3. [AzureAgent Usage](#AzureAgentUsage)
  4. [Azure AuthProvider Usage](#AzureAuthProviderUsage)
  5. [Azure Overriding Options Usage](#AzureWithOverridesUsage)
  6. [AzureAgent Overriding Options Usage](#AzureAgentWithOverridesUsage)
  - [GET](#ExampleGet)
  - [POST](#ExamplePost)
  - [PUT](#ExamplePut)
  - [DELETE](#ExampleDel)
  - [GetToken](#ExampleGetToken)
  - [Custom Headers](#ExampleCustomHeaders)
  - [Vault Information](#VaultInformation)

### Features

<a name="Features"/>

- Automatically loads credentials from vault without having to hardcode client secrets into your application
- Automatically retries authentication up to 5 times, if your client secret is rotated it will seamlessly reload the credentials from vault without having an application outage

### Install

<a name="Install"/>

`npm i @monsantoit/superagent-oauth`

### Setup

<a name="Setup"/>

The library exposes two entrypoints for making HTTP requests authorized by Ping or Azure.

Ping: `require("@monsantoit/superagent-oauth").agent`
Azure: `require("@monsantoit/superagent-oauth").azureAgent` **OR** `require("@monsantoit/superagent-oauth").agent` (if supplying the call with the `{ authProvider: "azure" }` argument.

These imports have the same calling API to send requests, just different backend authentication schemes. Primarily arguments for authenticating are set in the environment variables.

##### Ping

<a name="Ping"/>

```javascript
// the oauth clientId for authentication
process.env.CLIENT_ID = "PD-WORKFLOWINATOR-SVC";

// np or prod, used to determine which ping servers to obtain tokens from, only required if using ping
process.env.ENVIRONMENT = "np" || "prod";

// path to the client secret in vault
process.env.VAULT_SECRET_PATH =
  "vault://secret/pipeline/workflowinator/np/CLIENT_SECRET";

// the role used to connect to vault to obtain the client secret
process.env.VAULT_ROLE = "pipeline-dev-team-smartsheet-services-local";
```

##### Azure

<a name="Azure"/>

```javascript
// the oauth clientId for authentication
process.env.AZURE_CLIENT_ID = "aa831858-72e7-46cb-901c-0c63ffd59707";

// path to the client secret in vault
process.env.AZURE_VAULT_SECRET_PATH =
  "vault://secret/pipeline/nomination/service/np/AZURE_CLIENT_SECRET";

// the role used to connect to vault to obtain the client secret
process.env.AZURE_VAULT_ROLE = "pipeline-dev-team-smartsheet-services-local";
```

One thing to note is the vault path will have to be prepended with `vault://<YOUR_PATH>/<SECRET_KEY>` to correctly work. If for example you would normally read the Vault path of `/secret/pipeline/workflowinator/np` and the secret key of `CLIENT_SECRET` the path you would supply would be:

`vault://secret/pipeline/nomination/service/np/AZURE_CLIENT_SECRET`

The `CLIENT_ID` value will need to be the UUID value set inside of Azure AD. **Note:** This is _not_ the BEAT ID given to your application!

##### Passing In Values

<a name="overridingOptions"/>

##### Vault Integration

If you do not want to have your secrets live inside of Vault, you can also pass the client secret directly into your request and leave out the Vault-specific parameters.

Example:

```
const results = await agent.get(url, {
  authProvider: "ping",
  clientId: "PD-WORKFLOWINATOR-SVC",
  clientSecret: "my-totally-cool-secret",
  environment: "np"
});
```

##### Environment Variables

Alternatively if you do not wish to put these values inside of the environment variables, you may also supply these values inside the call to the library. Please see the [Example Usage](#example-usage) section to see how to pass this in correctly.

- authProvider
  - specifies whether to use azure or ping
- clientId
  - Overrides the `CLIENT_ID` or `AZURE_CLIENT_ID` environment variable, depending on which auth type you are using.
- environment
  - Overrides the `ENVIRONMENT` environment variable, depending on which auth type you are using.
- vaultSecretPath
  - Overrides the `VAULT_SECRET_PATH` or `AZURE_VAULT_SECRET_PATH` environment variable, depending on which auth type you are using.
- vaultRole
  - Overrides the `VAULT_ROLE` or `AZURE_VAULT_ROLE` environment variable, depending on which auth type you are using.

### Example Usage

<a name="Usage"/>

##### Using Ping (the default)

<a name="PingUsage"/>

```javascript
const agent = require("@monsantoit/superagent-oauth").agent;
process.env.CLIENT_ID = "PD-WORKFLOWINATOR-SVC";
process.env.ENVIRONMENT = "np";
process.env.VAULT_SECRET_PATH =
  "vault://secret/pipeline/workflowinator/np/CLIENT_SECRET";
process.env.VAULT_ROLE = "pipeline-dev-team-smartsheet-services-local";

const url =
  "https://velocity-np.ag/workflowinator/services/v1/workflow/by-workplan-id/42";

const results = await agent.get(url);
```

##### Using Ping (secrets pass via arguments)

<a name="PingWithOverridesUsage"/>

```javascript
const agent = require("@monsantoit/superagent-oauth").agent;
const url =
  "https://velocity-np.ag/workflowinator/services/v1/workflow/by-workplan-id/42";

const results = await agent.get(url, {
  authProvider: "ping",
  clientId: "PD-WORKFLOWINATOR-SVC",
  environment: "np",
  vaultSecretPath: "vault://secret/pipeline/workflowinator/np/CLIENT_SECRET",
  vaultRole: "pipeline-dev-team-smartsheet-services-local",
});
```

##### Using Azure (via the `azureAgent`)

<a name="AzureAgentUsage"/>

- An azureAgent is exported which supplies the correct internal options to support Azure authentication

```javascript
const agent = require("@monsantoit/superagent-oauth").azureAgent;
process.env.AZURE_CLIENT_ID = "aa831858-72e7-46cb-901c-0c63ffd59707";
process.env.AZURE_VAULT_SECRET_PATH =
  "vault://secret/pipeline/nomination/service/np/AZURE_CLIENT_SECRET";
process.env.AZURE_VAULT_ROLE = "pipeline-dev-team-smartsheet-services-local";

const url =
  "https://velocity-np.ag/workflowinator/services/v1/workflow/by-workplan-id/42";

const results = await agent.get(url);
```

##### Using Azure (via the `agent`)

<a name="AzureAuthProviderUsage"/>

- If the exported azureAgent is not used, the following combinations of options will still enable azure usage using the default agent

```javascript
const agent = require("@monsantoit/superagent-oauth").agent;
process.env.CLIENT_ID = "aa831858-72e7-46cb-901c-0c63ffd59707";
process.env.VAULT_SECRET_PATH =
  "vault://secret/pipeline/nomination/service/np/AZURE_CLIENT_SECRET";
process.env.VAULT_ROLE = "pipeline-dev-team-smartsheet-services-local";

const url =
  "https://velocity-np.ag/workflowinator/services/v1/workflow/by-workplan-id/42";

const results = await agent.get(url, { authProvider: "azure" });
```

##### Using Azure (via `agent`, secrets pass via arguments)

<a name="AzureWithOverridesUsage"/>

```javascript
const agent = require("@monsantoit/superagent-oauth").agent;
const url =
  "https://velocity-np.ag/workflowinator/services/v1/workflow/by-workplan-id/42";

const results = await agent.get(url, {
  authProvider: "ping",
  clientId: "aa831858-72e7-46cb-901c-0c63ffd59707",
  vaultSecretPath: "vault://secret/pipeline/workflowinator/np/CLIENT_SECRET",
  vaultRole: "pipeline-dev-team-smartsheet-services-local",
});
```

##### Using Azure (via `azureAgent`, secrets pass via arguments)

<a name="AzureAgentWithOverridesUsage"/>

```javascript
const agent = require("@monsantoit/superagent-oauth").azureAgent;
const url =
  "https://velocity-np.ag/workflowinator/services/v1/workflow/by-workplan-id/42";

const results = await agent.get(url, {
  authProvider: "ping",
  clientId: "aa831858-72e7-46cb-901c-0c63ffd59707",
  vaultSecretPath:
    "vault://secret/pipeline/nomination/service/np/AZURE_CLIENT_SECRET",
  vaultRole: "pipeline-dev-team-smartsheet-services-local",
});
```

### Example GET

<a name="ExampleGet"/>

```javascript
const get = async function (url, options) {...}
```

- Parameters

  - url - the endpoint to send the request
  - options - custom request options such as headers or internal library options such as authProvider. See [Example Usage](#AzureWithOverridesUsage) for using internal options.

- Example

```javascript
const url =
  "https://velocity-np.ag/workflowinator/services/v1/workflow/by-workplan-id/42";
const results = await agent.get(url, {});
console.info("response body:", results.body);
```

### Example POST

<a name="ExamplePost"/>

```javascript
const post = async function (url, options, body) {...}
```

- Parameters

  - url - the endpoint to send the request
  - options - custom request options such as headers or internal library options such as authProvider. See [Example Usage](#AzureWithOverridesUsage) for using internal options.
  - body - the JSON request body to send. If JSON is not the desired body type, you will need to include a content-type header in the options parameter

- Example

```javascript
const url =
  "https://velocity-np.ag/workflowinator/services/v1/workflow/by-workplan-id/42";
const results = await agent.post(url);
const options = {};
const body = {
  wsdl: config.get("WORKPLAN_SERVICE_WSDL"),
  method: "WorkplanServiceService",
  endpoint: "WorkplanServicePort",
  operation: "setSubmitUserAndDate",
  wsSecurityUsername: "SRGROD",
  body: {
    _xml: xmlBody,
  },
};
await agent.post(url, options, body);
console.info("response body:", results.body);
```

### Example PUT

<a name="ExamplePut"/>

```javascript
const put = async function (url, options, body) {...}
```

- Parameters
  - url - the endpoint to send the request
  - options - custom request options such as headers or internal library options such as authProvider. See [Example Usage](#AzureWithOverridesUsage) for using internal options.
  - body - the JSON request body to send. If JSON is not the desired body type, you will need to include a content-type header in the options parameter
- Example

```javascript
const body = {
  complete: true,
  completedBy,
  result: "Approved",
  tag: "Velocity Nomination",
  tagKey: `TRANSFORMATION-DEVIATION-${vectorId}`,
};
const url = `${config.get("TASKS_URL")}/complete`;
const result = await authorizedAgent.put(url, {}, body);
```

### Example DELETE (DEL)

<a name="ExampleDel"/>

```javascript
const del = async function (url, options, body) {...}
```

- Parameters

  - url - the endpoint to send the request
  - options - custom request options such as headers or internal library options such as authProvider. See [Example Usage](#AzureWithOverridesUsage) for using internal options.
  - body(it is an optional parameter) - the JSON request body to send. If JSON is not the desired body type, you will need to include a content-type header in the options parameter
- Example

```javascript
const url = `${config.get("TASKS_URL")}/delete`;
const result = await authorizedAgent.del(url, {}, body);
```

### Example PATCH

<a name="ExamplePatch"/>

```javascript
const patch = async function (url, options, body) {...}
```

- Parameters
  - url - the endpoint to send the request
  - options - custom request options such as headers or internal library options such as authProvider. See [Example Usage](#AzureWithOverridesUsage) for using internal options.
  - body - the JSON request body to send. If JSON is not the desired body type, you will need to include a content-type header in the options parameter
- Example

```javascript
const body = 
  [
    {
      "id": 3423,
      "materialName": "123",
      "materialType": "internalSeed",
      "productType": "inv"
    }
  ];

const url = `${config.get("TASKS_URL")}/materials`;
const result = await authorizedAgent.patch(url, {}, body);
```

### Example using getToken

<a name="ExampleGetToken"/>

- This can be used to obtain a bearer token without making a request

```javascript
const getToken = async (opts) => {...}
```

- Parameters
  - opts - Object with the following properies
    - authProvider (optional) - can set to "azure", not specifying this option resorts to ping
    - clientId - the oauth clientId
    - environment - used to determine which endpoint to use for obtaining a bearer token, valid values are "np" or "prod"
    - vaultSecretPath - the vault path to the secret, example value: "vault://secret/pipeline/nomination/service/np/AZURE_CLIENT_SECRET"
    - vaultRole - the role to use when retrieving the vault secret, example value: "pipeline-dev-team-smartsheet-services-local"
  - the above parameters can alternatively be retrieved from environment variables
    - CLIENT_ID (ping)
    - AZURE_CLIENT_ID (azure)
    - ENVIRONMENT
    - AZURE_VAULT_SECRET_PATH (azure)
    - VAULT_SECRET_PATH (ping)
    - AZURE_VAULT_ROLE (azure)
    - VAULT_ROLE (ping)

### Example using custom headers

<a name="ExampleCustomHeaders"/>

- The options parameter can be used to include custom request headers

```javascript
const options = {
  headers: {
    "content-type": "text/xml",
    "user-id": "srgrod",
  },
};
const body = "<myBody>My Value</myBody>";
const results = await agent.post(url, options, body);
```

### Extra information about vault roles

<a name="VaultInformation"/>

- For information about creating aws-roles see https://devtools.monsanto.net/docs/credentials/aws-roles
- For information about vault see https://devtools.monsanto.net/docs/credentials/vault/

# Testing

Please note, if you need to run tests you will have to be logged into the Nomination non-prod account (`awssso 110551655353/standard-user`). In addition you will need to write a `.env.json` file in the root of the project in the following format: _(You can find the secret values by reading the vault path supplied in the tests.)_

```
{
  "azureClientSecret": "YOUR AZURE CLIENT SECRET HERE",
  "pingClientSecret": "YOUR PING CLIENT SECRET HERE"
}
```

If you do not have access to the Nomination non-prod account and need to set up a configuration that will work for the team that you are on, you can do this by copying the format of the file found in `test/pipeline-dev.json` You will need a valid Ping client and secret, vault roles correctly set up in Fort Knox, as well as an endpoint that will authorize making requests to them.

**Please note at time of writing,** some tests will require manually updated, as some endpoints need to be triggered to cause an error when making the API request.
