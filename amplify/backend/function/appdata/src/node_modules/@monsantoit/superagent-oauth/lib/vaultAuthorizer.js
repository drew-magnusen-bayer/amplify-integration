const addAuthorization = require("./addAuthorization")
const retrieveCredentials = require("./retrieveCredentials")
const _ = require("lodash")

let credentialsCache
const MAX_RETRIES = 5

module.exports = {
  async authorize(params, timesTried = 0) {
    if (timesTried > 0 || _.isEmpty(credentialsCache)) {
      credentialsCache = await retrieveCredentials.retrieve(params)
    }

    try {
      if (_.isEqual(params.authProvider, "azure")) {
        return await addAuthorization.azureAuthorize(credentialsCache)
      } else {
        return await addAuthorization.pingAuthorize(credentialsCache)
      }
    } catch (error) {
      if (timesTried < MAX_RETRIES) {
        console.warn("Error authenticating, retrying, attempt #", timesTried + 1, error)
        return await this.authorize(params, timesTried + 1)
      }
      throw error
    }
  },
}
