
# Testing

Testing setup depends on your testing framework of choice. Whatever you choose, the biggest hurdle is getting the config initialized before other files are required.

## Testing with Jest
If you start using Jest, if you have a file utilizing @monsantoit/config, you will probably end up with the error:
``` 
Config value fetched before config has been initialized.
```
  
So we want to be able to set it up so the config is always loaded when you run your tests, without having to add it to each individual test.  To make this work you will need to utilize a Jest Custom Environment, plus some tweaks to your Jest settings to utilize it.

The way this works is the custom environment will run on the start, and call the config.init() as part of the *setup* call, which allows for async methods.  
Unfortunately, due to the scoping this is not enough for your code to utilize it.  So we take the result and store it into a global *__INITIALIZED_CONFIG__*.

Next we need to utilize this global in the setup that will be run for every test.  We will take the global config, and put it into a Jest mock so it will be served up each time its needed.  It's a simple one liner in a configSetup.js file.

```
jest.mock('../src/config', () => global.__INITIALIZED_CONFIG__)
```

Finally we need to hook this all up.  You can do this under a *jest* section of your *package.json or in your *.jestrc.json* file.
```
    "testPathIgnorePatterns": [
      "<rootDir>/src/config/"
    ],
    "testEnvironment": "./test/testEnvironment",
    "setupFiles": [
      "./test/configSetup.js"
    ],
```

Note we've also added a testPathIgnorePatterns, as it will attempt to load *test.js* as a test file.

[A full code example](https://github.platforms.engineering/SRMACDO/config-jest) is available for you to look at as well. 

## Testing with Mocha
Mocha lets you require files, but the require process must be synchronous. Config's initilization is
asynchronous, so we need to wrap mocha.

### Wrapping Mocha Example

We're creating a new binary in our project - `bin/mocha` and we'll make it executable
`chmod+x bin/mocha`

Add the following to the contents of `bin/mocha`
```
#!/usr/bin/env node

const config = require('../src/config') // or wherever your config store is.

config.init()
    .then(() => 
        // config is initialized - run mocha.
        require('mocha/bin/mocha')
    })
    .catch(err => {
        console.error(err)
        process.exit(1)
    })
```

And that's it! You'll make a small change to your scripts - anywhere you had `mocha`, just replace it with `bin/mocha`

So if your original script was:

```
NODE_ENV=integration-test mocha --timeout 50000 --exit integrationTest
```

it would become:

```
NODE_ENV=integration-test ./bin/mocha --timeout 50000 --exit integrationTest
```

---

### Legacy Method

Pre mocha 7.1.0, you can extend mocha with `mocha-prepare`, which enables some pre-test hooks.

#### Install Mocha Prepare

```
npm install mocha-prepare --save-dev
```

#### Create your preparation file

mocha-prepare still uses the older done-style callbacks.

``` javascript

const prepare = require('mocha-prepare')
const config = require('../config/store')

prepare((done) =>
    config
        .init()
        .then(() => done())
        .catch(done) // pass the error along so the call-stack shows what's up.
)
```

### Update your test options
add it to your `mocha.opts` or `mocharc.json` config file.

``` bash
...your original config here, excluding requires

--require test/prepare

... any other required files.
```

## Disabling Processors

If you don't want to use a processor when testing (for example, maybe you don't want vault values to be fetched), you can disable those in your config class based on the environment.

``` js
const {Config, env, source, processor} = require('@monsantoit/config')

const config = new Config({
    sources: [
        source.fromJS({ src: 'some-config-path }),
        source.fromCloudFoundry(),
    ],
    processors: [
        processor.readVaultFromConfig({
            enabled: env.not('test','integration-test'),
            ...yourOtherConfig,
        }),
    ]
})
```


